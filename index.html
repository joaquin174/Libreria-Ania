<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inventario - Librería Ania</title>
<style>
  body {
    margin: 0;
    padding: 2em;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url('https://i.ibb.co/4ZTTVkgx/papeleria-1-66fe77df-9580-4bae-9e3c-4ce0f59fa290.webp') no-repeat center center fixed;
    background-size: cover;
    color: #00ffff;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  h1 {
    text-align: center;
    text-shadow: 0 0 6px #00ffff;
  }
  .producto {
    background: rgba(0, 188, 212, 0.7);
    margin: 1em auto;
    padding: 1em;
    max-width: 400px;
    border-radius: 12px;
    box-shadow: 3px 3px 6px #008ba3, -3px -3px 6px #00ffff;
  }
  button.venderBtn {
    margin-top: 0.5em;
    padding: 0.5em 1em;
    background: linear-gradient(145deg, #2196f3, #0d47a1);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 3px 3px 6px #0b3c83, -3px -3px 6px #42a5f5;
    transition: background 0.3s ease;
  }
  button.venderBtn:hover {
    background: linear-gradient(145deg, #0d47a1, #2196f3);
  }
  #btnCargarExcel {
    display: block;
    margin: 1em auto 3em auto;
    padding: 0.7em 1.5em;
    font-size: 1.1rem;
    cursor: pointer;
    background: linear-gradient(145deg, #4caf50, #087f23);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    box-shadow: 5px 5px 8px #087f23, -5px -5px 8px #81c784;
    transition: background 0.3s ease;
  }
  #btnCargarExcel:hover {
    background: linear-gradient(145deg, #087f23, #4caf50);
  }
  #btnIrVenderCelular {
    display: block;
    margin: 1em auto 3em auto;
    padding: 0.7em 1.5em;
    font-size: 1.1rem;
    cursor: pointer;
    background: linear-gradient(145deg, #ff5722, #bf360c);
    border: none;
    border-radius: 12px;
    color: white;
    font-weight: bold;
    box-shadow: 5px 5px 8px #bf360c, -5px -5px 8px #ff8a50;
    transition: background 0.3s ease;
  }
  #btnIrVenderCelular:hover {
    background: linear-gradient(145deg, #bf360c, #ff5722);
  }
  #mensaje {
    text-align: center;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 1em;
    text-shadow: 0 0 5px #00ffff;
  }
</style>
</head>
<body>

<h1>Inventario - Librería Ania</h1>

<div id="productosContainer"></div>

<input type="file" id="fileInput" accept=".xls,.xlsx" style="display:none" />
<button id="btnCargarExcel">Cargar archivo Excel</button>

<button id="btnIrVenderCelular">Ir a Vender en Celular</button>

<div id="mensaje"></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
(() => {
  const MIN_STOCK = 2;

  let productos = [];

  const productosContainer = document.getElementById('productosContainer');
  const mensaje = document.getElementById('mensaje');
  const fileInput = document.getElementById('fileInput');
  const btnCargarExcel = document.getElementById('btnCargarExcel');
  const btnIrVenderCelular = document.getElementById('btnIrVenderCelular');

  // Funciones locales para guardar y cargar productos
  function guardarProductos() {
    localStorage.setItem('productos', JSON.stringify(productos));
  }
  function cargarProductos() {
    const data = localStorage.getItem('productos');
    if (data) {
      productos = JSON.parse(data);
    }
  }

  // Renderizar productos con botón vender
  function renderizarProductos() {
    productosContainer.innerHTML = '';
    productos.forEach(producto => {
      const div = document.createElement('div');
      div.className = 'producto';
      div.innerHTML = `
        <strong>${producto.nombre}</strong><br>
        Stock: ${producto.stock} unidades
      `;
      const btnVender = document.createElement('button');
      btnVender.textContent = 'Vender 1 unidad';
      btnVender.className = 'venderBtn';
      btnVender.disabled = producto.stock <= MIN_STOCK;
      btnVender.onclick = () => {
        if (producto.stock > MIN_STOCK) {
          producto.stock--;
          guardarProductos();
          renderizarProductos();
          revisarAlertas();
          broadcastUpdate();
          mensaje.textContent = 'Venta realizada.';
        }
      };
      div.appendChild(btnVender);
      productosContainer.appendChild(div);
    });
  }

  // Mostrar alerta con input y voz
  function mostrarAlerta(producto) {
    if(document.getElementById(`alerta-${producto.id}`)) return;

    const alerta = document.createElement('div');
    alerta.id = `alerta-${producto.id}`;
    alerta.style.position = 'fixed';
    alerta.style.bottom = '10px';
    alerta.style.right = '10px';
    alerta.style.background = '#ffeb3b';
    alerta.style.padding = '1em';
    alerta.style.marginTop = '10px';
    alerta.style.borderRadius = '10px';
    alerta.style.boxShadow = '0 0 10px #000';
    alerta.style.zIndex = 9999;
    alerta.innerHTML = `
      <strong>¡Stock mínimo!</strong><br>
      ${producto.nombre} tiene ${producto.stock} unidades.<br>
      <input type="number" min="1" placeholder="Cantidad a reponer" id="input-${producto.id}" style="margin-top:8px; padding:4px; width: 120px;" />
      <br>
      <button id="btnCerrar-${producto.id}" disabled style="margin-top:8px;">Cerrar alerta</button>
    `;
    document.body.appendChild(alerta);

    // Voz con SpeechSynthesis API
    const mensajeVoz = new SpeechSynthesisUtterance(`Atención. El producto ${producto.nombre} ha llegado a su stock mínimo.`);
    mensajeVoz.lang = 'es-ES';
    speechSynthesis.speak(mensajeVoz);

    const input = document.getElementById(`input-${producto.id}`);
    const btnCerrar = document.getElementById(`btnCerrar-${producto.id}`);

    input.addEventListener('input', () => {
      const valor = parseInt(input.value, 10);
      btnCerrar.disabled = isNaN(valor) || valor <= 0;
    });

    btnCerrar.addEventListener('click', () => {
      const cantidad = parseInt(input.value, 10);
      if (!isNaN(cantidad) && cantidad > 0) {
        producto.stock += cantidad;
        guardarProductos();
        renderizarProductos();
        alerta.remove();
        speechSynthesis.cancel();
      }
    });
  }

  // Revisar alertas para productos con stock bajo o igual a MIN_STOCK
  function revisarAlertas() {
    productos.forEach(producto => {
      if(producto.stock <= MIN_STOCK) {
        mostrarAlerta(producto);
      } else {
        // Si hay alerta pero el stock ya no es mínimo, eliminar alerta si existe
        const alerta = document.getElementById(`alerta-${producto.id}`);
        if(alerta) {
          alerta.remove();
          speechSynthesis.cancel();
        }
      }
    });
  }

  // BroadcastChannel para sincronizar
  const bc = new BroadcastChannel('inventario_libreria_ania');

  function broadcastUpdate() {
    bc.postMessage({ type: 'update', productos });
  }

  bc.onmessage = (ev) => {
    if(ev.data.type === 'update' && ev.data.productos) {
      productos = ev.data.productos;
      guardarProductos();
      renderizarProductos();
      revisarAlertas();
      mensaje.textContent = '';
    }
  };

  // Excel - procesar archivo
  function procesarArchivoExcel(e) {
    const archivo = e.target.files[0];
    if (!archivo) return;

    const reader = new FileReader();
    reader.onload = (ev) => {
      const data = new Uint8Array(ev.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const nombreHoja = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[nombreHoja];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ''});

      // Asumimos que el Excel tiene columnas: id, nombre, stock
      productos = jsonData.map(item => ({
        id: Number(item.id),
        nombre: String(item.nombre),
        stock: Number(item.stock)
      }));

      guardarProductos();
      renderizarProductos();
      revisarAlertas();
      broadcastUpdate();
      mensaje.textContent = 'Lista de productos actualizada desde Excel.';
    };
    reader.readAsArrayBuffer(archivo);
  }

  btnCargarExcel.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', procesarArchivoExcel);

  btnIrVenderCelular.addEventListener('click', () => {
    window.open('vender_celular.html', '_blank');
  });

  // Cargar productos iniciales
  cargarProductos();
  renderizarProductos();
  revisarAlertas();

})();
</script>

</body>
</html>
