<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>INVENTARIO LIBRERIA ANIA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: transparent;
      color: #fff;
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      font-size: 2em;
      color: #00ffff;
      text-shadow: 0 0 10px #00ffff;
      margin-top: 1em;
    }
    #productos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1em;
      padding: 1em;
    }
    .producto {
      background: rgba(0,0,0,0.5);
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 1em;
      text-align: center;
      box-shadow: 0 0 10px #00ffff;
    }
    button {
      background: linear-gradient(145deg, #00ffff, #00cccc);
      border: none;
      color: #000;
      font-weight: bold;
      padding: 0.6em 1.2em;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px #008080;
      transition: transform 0.2s;
    }
    button:hover {
      transform: scale(1.05);
    }
    #alerta {
      position: fixed;
      bottom: 1em;
      right: 1em;
      background: #ff0040;
      color: white;
      padding: 1em;
      border-radius: 10px;
      box-shadow: 0 0 10px #ff0040;
      display: none;
      z-index: 1000;
    }
    #boton-reabrir {
      position: fixed;
      bottom: 1em;
      right: 1em;
      background: #ffaa00;
      padding: 0.5em 1em;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      cursor: pointer;
      font-weight: bold;
    }
    #menu {
      display: flex;
      justify-content: center;
      gap: 1em;
      margin: 1em;
      flex-wrap: wrap;
    }
    input[type=file] {
      color: #fff;
    }
  </style>
</head>
<body>

<h1>INVENTARIO LIBRERIA ANIA</h1>

<div id="menu">
  <button id="btn-vender-celular">Vender en celular</button>
  <label>
    <input type="file" id="input-excel" accept=".xlsx, .xls" />
    Subir Excel
  </label>
</div>

<div id="productos"></div>

<div id="alerta">
  <span id="alerta-mensaje"></span><br>
  <button id="btn-minimizar">Minimizar</button>
  <button id="btn-cerrar">Cerrar</button>
</div>

<div id="boton-reabrir">ðŸ”” Ver alerta</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const minimo = 2;
  const maximo = 12;
  let productos = [];
  let alertaAbierta = false;
  let alertaMinimizada = false;
  let alertaProducto = null;
  const synth = window.speechSynthesis;

  const divProductos = document.getElementById('productos');
  const alerta = document.getElementById('alerta');
  const alertaMensaje = document.getElementById('alerta-mensaje');
  const btnMinimizar = document.getElementById('btn-minimizar');
  const btnCerrar = document.getElementById('btn-cerrar');
  const botonReabrir = document.getElementById('boton-reabrir');
  const btnVenderCelular = document.getElementById('btn-vender-celular');
  const inputExcel = document.getElementById('input-excel');

  function guardarProductos() {
    localStorage.setItem('productos', JSON.stringify(productos));
  }

  function inicializarProductos() {
    const datos = localStorage.getItem('productos');
    if (datos) {
      productos = JSON.parse(datos);
    } else {
      productos = [
        {id: 1, nombre: "Cuaderno", stock: 10},
        {id: 2, nombre: "LÃ¡piz", stock: 12},
        {id: 3, nombre: "Borrador", stock: 8}
      ];
      guardarProductos();
    }
  }

  function renderizarProductos() {
    divProductos.innerHTML = "";
    productos.forEach(prod => {
      const div = document.createElement('div');
      div.className = "producto";
      div.innerHTML = `
        <h3>${prod.nombre}</h3>
        <p>Stock: ${prod.stock}</p>
        <button onclick="vender(${prod.id})">Vender</button>
      `;
      divProductos.appendChild(div);
    });
  }

  function vender(id) {
    const p = productos.find(x => x.id === id);
    if (p && p.stock > 0) {
      p.stock--;
      guardarProductos();
      renderizarProductos();
      checarAlerta();
    }
  }

  function checarAlerta() {
    const p = productos.find(p => p.stock <= minimo);
    if (p && (!alertaAbierta || alertaProducto?.id !== p.id)) {
      mostrarAlerta(p);
    }
  }

  function mostrarAlerta(p) {
    alertaProducto = p;
    alertaMensaje.textContent = `âš ï¸ ${p.nombre} tiene stock bajo (${p.stock})`;
    alerta.style.display = 'block';
    alertaAbierta = true;
    alertaMinimizada = false;
    botonReabrir.style.display = 'none';
    reproducirAlerta(`${p.nombre} tiene stock bajo. Quedan ${p.stock} unidades.`);
  }

  function reproducirAlerta(mensaje) {
    if (synth.speaking) synth.cancel();
    for (let i = 0; i < 3; i++) {
      const utter = new SpeechSynthesisUtterance(mensaje);
      utter.lang = 'es-ES';
      synth.speak(utter);
    }
  }

  function cerrarAlerta() {
    alerta.style.display = 'none';
    alertaAbierta = false;
    alertaMinimizada = false;
    alertaProducto = null;
    if (synth.speaking) synth.cancel();
  }

  btnCerrar.onclick = cerrarAlerta;

  btnMinimizar.onclick = () => {
    alerta.style.display = 'none';
    alertaAbierta = false;
    alertaMinimizada = true;
    botonReabrir.style.display = 'block';
    if (synth.speaking) synth.cancel();
  };

  botonReabrir.onclick = () => {
    if (alertaProducto) {
      alerta.style.display = 'block';
      alertaAbierta = true;
      alertaMinimizada = false;
      botonReabrir.style.display = 'none';
      reproducirAlerta(`${alertaProducto.nombre} tiene stock bajo. Quedan ${alertaProducto.stock} unidades.`);
    }
  };

  btnVenderCelular.onclick = () => {
    window.open('vender_celular.html', '_blank');
  };

  inputExcel.onchange = (evt) => {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {header:1});
      productos = [];
      for(let i=1; i<json.length; i++) {
        const nombre = json[i][0];
        let stock = parseInt(json[i][1]);
        if (nombre && !isNaN(stock)) {
          stock = Math.min(Math.max(stock, minimo), maximo);
          productos.push({id: i, nombre, stock});
        }
      }
      guardarProductos();
      renderizarProductos();
      checarAlerta();
    };
    reader.readAsArrayBuffer(file);
  };

  window.addEventListener('storage', (e) => {
    if (e.key === 'productos') {
      productos = JSON.parse(e.newValue);
      renderizarProductos();
      checarAlerta();
    }
  });

  setInterval(() => {
    const actual = JSON.parse(localStorage.getItem('productos') || '[]');
    if (JSON.stringify(actual) !== JSON.stringify(productos)) {
      productos = actual;
      renderizarProductos();
      checarAlerta();
    }
  }, 3000);

  inicializarProductos();
  renderizarProductos();
  checarAlerta();

</script>
</body>
</html>
