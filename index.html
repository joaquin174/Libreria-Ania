<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INVENTARIO LIBRERIA ANIA</title>
  <style>
    body {
      margin: 0;
      padding: 2em;
      font-family: 'Segoe UI', sans-serif;
      background: transparent;
      color: #00ffff;
      backdrop-filter: blur(15px);
    }
    h1 {
      text-align: center;
      text-shadow: 0 0 10px #00ffff;
    }
    .top-bar {
      text-align: center;
      margin-bottom: 2em;
    }
    .producto {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.5);
      padding: 1em;
      border-radius: 10px;
      margin-bottom: 1em;
      box-shadow: 0 0 10px #00ffff;
    }
    button {
      background: linear-gradient(145deg, #00ffff, #00cccc);
      border: none;
      border-radius: 10px;
      padding: 0.5em 1em;
      color: #000;
      font-weight: bold;
      box-shadow: 0 4px #008080;
      cursor: pointer;
    }
    #alertas {
      position: fixed;
      bottom: 1em;
      right: 1em;
      max-width: 300px;
      z-index: 9999;
    }
    .alerta {
      background: rgba(255, 0, 0, 0.9);
      color: #fff;
      margin-top: 1em;
      padding: 1em;
      border-radius: 10px;
      box-shadow: 0 0 10px red;
    }
    .alerta button {
      margin-top: 0.5em;
      background: #fff;
      color: #b30000;
      box-shadow: none;
    }
  </style>
</head>
<body>

<div class="top-bar">
  <h1>INVENTARIO LIBRERIA ANIA</h1>
  <button onclick="window.open('vender_celular.html', '_blank')">Vender en celular</button>
</div>

<div id="productos"></div>
<div id="alertas"></div>

<script>
  const MINIMO = 2;
  const MAXIMO = 12;

  let productos = [
    { id: 1, nombre: "Producto 1", stock: 12 },
    { id: 2, nombre: "Producto 2", stock: 12 },
    { id: 3, nombre: "Producto 3", stock: 12 }
  ];

  let alertasActivas = new Set();
  const productosDiv = document.getElementById('productos');
  const alertasDiv = document.getElementById('alertas');

  function guardarProductos() {
    localStorage.setItem('productos', JSON.stringify(productos));
  }

  function cargarProductos() {
    const data = localStorage.getItem('productos');
    if (data) {
      productos = JSON.parse(data);
    }
  }

  function renderProductos() {
    productosDiv.innerHTML = '';
    productos.forEach(p => {
      const div = document.createElement('div');
      div.className = 'producto';
      div.innerHTML = `
        <span>${p.nombre} - Stock: ${p.stock}</span>
        <button onclick="vender(${p.id})">Vender</button>
      `;
      productosDiv.appendChild(div);
    });
  }

  function vender(id) {
    const prod = productos.find(p => p.id === id);
    if (prod && prod.stock > MINIMO) {
      prod.stock--;
      guardarProductos();
      renderProductos();
      verificarAlerta(prod);
    }
  }

  function verificarAlerta(p) {
    if (p.stock <= MINIMO && !alertasActivas.has(p.id)) {
      crearAlerta(p);
      alertasActivas.add(p.id);
    }
  }

  function crearAlerta(p) {
    const div = document.createElement('div');
    div.className = 'alerta';
    div.id = `alerta-${p.id}`;
    div.innerHTML = `
      <div>⚠️ Producto "${p.nombre}" en stock mínimo (${p.stock})</div>
      <button onclick="cerrarAlerta(${p.id})">Cerrar y reiniciar</button>
    `;
    alertasDiv.appendChild(div);
    reproducirAlertaVoz(p);
  }

  function cerrarAlerta(id) {
    const prod = productos.find(p => p.id === id);
    if (prod) {
      prod.stock = MAXIMO;
      guardarProductos();
      renderProductos();
    }
    const div = document.getElementById(`alerta-${id}`);
    if (div) div.remove();
    alertasActivas.delete(id);
    if (speechSynthesis.speaking) speechSynthesis.cancel();
  }

  function reproducirAlertaVoz(p) {
    let count = 0;
    const msg = new SpeechSynthesisUtterance(`Alerta de inventario: Producto ${p.nombre}, quedan ${p.stock} unidades`);
    msg.rate = 1;
    msg.onend = () => {
      count++;
      if (count < 3) {
        speechSynthesis.speak(msg);
      }
    };
    speechSynthesis.speak(msg);
  }

  function iniciar() {
    cargarProductos();
    renderProductos();
    productos.forEach(p => {
      if (p.stock <= MINIMO) {
        verificarAlerta(p);
      }
    });
  }

  // Reaccionar a ventas desde la segunda página
  window.addEventListener('storage', e => {
    if (e.key === 'productos') {
      cargarProductos();
      renderProductos();
      productos.forEach(p => verificarAlerta(p));
    }
    if (e.key === 'alertaProducto') {
      const alerta = JSON.parse(localStorage.getItem('alertaProducto'));
      if (alerta && alerta.stock <= MINIMO && !alertasActivas.has(alerta.id)) {
        const prod = productos.find(p => p.id === alerta.id);
        if (prod) {
          crearAlerta(prod);
          alertasActivas.add(prod.id);
        }
      }
    }
  });

  iniciar();
</script>
</body>
</html>
