<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>INVENTARIO LIBRERIA ANIA</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: transparent;
    color: #00ffff;
    backdrop-filter: blur(15px);
    padding: 1em;
  }
  h1 {
    text-align: center;
    font-weight: 900;
    text-shadow: 0 0 15px #00ffff;
    margin-bottom: 1em;
  }
  .producto {
    background: rgba(0,0,0,0.5);
    margin: 0.5em 0;
    padding: 1em;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 0 10px #00ffff;
  }
  .producto span {
    font-size: 1.2em;
  }
  button.vender {
    background: linear-gradient(145deg, #00ffff, #00cccc);
    color: black;
    font-weight: bold;
    padding: 0.5em 1em;
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px #008080;
    cursor: pointer;
    user-select: none;
    transition: all 0.2s ease;
  }
  button.vender:active {
    box-shadow: none;
    transform: translateY(4px);
  }
  #alertas-container {
    position: fixed;
    bottom: 1em;
    right: 1em;
    max-width: 300px;
    z-index: 1000;
  }
  .alerta-producto {
    background: rgba(255,0,0,0.9);
    color: white;
    padding: 0.8em 1em;
    margin-top: 0.6em;
    border-radius: 12px;
    box-shadow: 0 0 10px red;
    font-weight: bold;
    position: relative;
  }
  .alerta-producto span {
    display: block;
  }
  .alerta-btn {
    background: #fff;
    border: none;
    border-radius: 8px;
    padding: 0.3em 0.7em;
    font-weight: 700;
    cursor: pointer;
    margin-left: 0.5em;
    color: #b30000;
    box-shadow: 0 3px #800000;
    user-select: none;
    transition: all 0.2s ease;
  }
  .alerta-btn:active {
    box-shadow: none;
    transform: translateY(2px);
  }
</style>
</head>
<body>

<h1>INVENTARIO LIBRERIA ANIA</h1>

<div id="productos-lista"></div>

<div id="alertas-container"></div>

<script>
const MINIMO = 2;
const MAXIMO = 12;

// Productos iniciales ejemplo (puedes modificar o cargar Excel)
// id único para cada producto
let productos = [
  { id: 1, nombre: "Producto 1", stock: 12 },
  { id: 2, nombre: "Producto 2", stock: 12 },
  { id: 3, nombre: "Producto 3", stock: 12 },
];

// Para alertas activas (por producto)
let alertasActivas = new Set();

const productosLista = document.getElementById('productos-lista');
const alertasContainer = document.getElementById('alertas-container');

function guardarLocal() {
  localStorage.setItem('productos', JSON.stringify(productos));
}

function cargarLocal() {
  const data = localStorage.getItem('productos');
  if (data) productos = JSON.parse(data);
}

function renderProductos() {
  productosLista.innerHTML = '';
  productos.forEach(p => {
    const div = document.createElement('div');
    div.className = 'producto';
    div.innerHTML = `
      <span>${p.nombre} - Stock: ${p.stock}</span>
      <button class="vender" data-id="${p.id}">Vender</button>
    `;
    productosLista.appendChild(div);
  });
  // Añadir eventos a botones vender
  document.querySelectorAll('button.vender').forEach(btn => {
    btn.onclick = () => {
      const id = parseInt(btn.getAttribute('data-id'));
      venderProducto(id);
    };
  });
}

function venderProducto(id) {
  const p = productos.find(x => x.id === id);
  if (!p) return;
  if (p.stock <= MINIMO) {
    // ya está en alerta, no vender más
    return;
  }
  p.stock--;
  guardarLocal();
  renderProductos();
  checkAlertaProducto(p);
}

// Genera o elimina alerta según stock del producto
function checkAlertaProducto(p) {
  if (p.stock <= MINIMO) {
    if (!alertasActivas.has(p.id)) {
      crearAlerta(p);
      alertasActivas.add(p.id);
    }
  } else {
    // Si el stock subió, eliminar alerta si existiera
    if (alertasActivas.has(p.id)) {
      eliminarAlerta(p.id);
      alertasActivas.delete(p.id);
    }
  }
}

// Crear alerta individual para producto
function crearAlerta(p) {
  // Crear contenedor alerta
  const alertaDiv = document.createElement('div');
  alertaDiv.className = 'alerta-producto';
  alertaDiv.id = `alerta-${p.id}`;
  alertaDiv.innerHTML = `
    <span>¡Alerta! Stock mínimo: ${p.nombre} - Quedan ${p.stock}</span>
    <button class="alerta-btn" title="Cerrar y reiniciar stock">Cerrar</button>
  `;
  alertasContainer.appendChild(alertaDiv);

  // Sonido alerta con SpeechSynthesis (3 repeticiones)
  reproducirAlertaVoz(p);

  // Botón cerrar alerta
  alertaDiv.querySelector('button.alerta-btn').onclick = () => {
    reiniciarStockProducto(p.id);
    eliminarAlerta(p.id);
    alertasActivas.delete(p.id);
  };
}

// Eliminar alerta del DOM
function eliminarAlerta(id) {
  const alerta = document.getElementById(`alerta-${id}`);
  if (alerta) alerta.remove();
}

// Reinicia el stock del producto al máximo y actualiza
function reiniciarStockProducto(id) {
  const p = productos.find(x => x.id === id);
  if (!p) return;
  p.stock = MAXIMO;
  guardarLocal();
  renderProductos();
}

// Voz alerta con repeticiones
let sintetizador = window.speechSynthesis;
let utterance;
let alertasVozMap = new Map(); // para controlar múltiples alertas

function reproducirAlertaVoz(p) {
  if (!sintetizador) return;
  if (alertasVozMap.has(p.id)) {
    // Si ya está sonando, cancelar y reiniciar
    sintetizador.cancel();
    alertasVozMap.delete(p.id);
  }

  let count = 0;
  utterance = new SpeechSynthesisUtterance(`Atención, producto ${p.nombre}, stock mínimo, quedan ${p.stock} unidades`);
  utterance.rate = 1;
  utterance.onend = () => {
    count++;
    if (count < 3) {
      sintetizador.speak(utterance);
    } else {
      alertasVozMap.delete(p.id);
    }
  };
  alertasVozMap.set(p.id, utterance);
  sintetizador.speak(utterance);
}

// Al cargar la página
function iniciar() {
  cargarLocal();
  renderProductos();
  // Verificar alertas para productos que ya están en mínimo
  productos.forEach(p => {
    if (p.stock <= MINIMO) {
      if (!alertasActivas.has(p.id)) {
        crearAlerta(p);
        alertasActivas.add(p.id);
      }
    }
  });
}

window.addEventListener('storage', (e) => {
  if (e.key === 'productos') {
    cargarLocal();
    renderProductos();
    productos.forEach(p => checkAlertaProducto(p));
  }
});

iniciar();

</script>

</body>
</html>
