<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Vender - Librería Ania</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
      color: #00ffff;
      backdrop-filter: blur(15px);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
      min-height: 100vh;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 10px #00ffff;
      margin-bottom: 1em;
      font-weight: 900;
      font-size: 1.8em;
    }
    select {
      width: 90%;
      padding: 1em;
      font-size: 1.2em;
      border-radius: 12px;
      border: 2px solid #00ffff;
      background: rgba(0,0,0,0.6);
      color: #00ffff;
      box-shadow: 0 0 15px #00ffff inset;
      margin-bottom: 1em;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
    }
    select option[disabled] {
      color: #888;
    }
    button {
      width: 90%;
      padding: 1em;
      font-size: 1.3em;
      font-weight: bold;
      color: #000;
      background: linear-gradient(145deg, #00ffff, #00cccc);
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px #008080;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1em;
      user-select: none;
    }
    button:active {
      box-shadow: none;
      transform: translateY(4px);
    }
    button:disabled {
      background: #444;
      color: #666;
      box-shadow: none;
      cursor: not-allowed;
    }
    #descargar {
      background: linear-gradient(145deg, #ff6a00, #ff8c00);
      color: #fff;
      box-shadow: 0 5px #c14a00;
    }
  </style>
</head>
<body>

<h2>Vender en celular</h2>

<select id="select-productos">
  <option value="" disabled selected>No hay productos</option>
</select>

<button id="btn-vender">Vender</button>
<button id="descargar">Descargar reporte stock mínimo</button>

<script>
  const minimo = 2;

  const selectProductos = document.getElementById('select-productos');
  const btnVender = document.getElementById('btn-vender');
  const btnDescargar = document.getElementById('descargar');

  let productos = [];

  function cargarProductos() {
    const data = localStorage.getItem('productos');
    productos = data ? JSON.parse(data) : [];
    actualizarSelect();
  }

  function actualizarSelect() {
    selectProductos.innerHTML = '';
    if (productos.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = 'No hay productos';
      opt.disabled = true;
      opt.selected = true;
      selectProductos.appendChild(opt);
      btnVender.disabled = true;
      return;
    }

    productos.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.nombre} (Stock: ${p.stock})`;
      // Bloquear si está en alerta (stock <= minimo)
      if (p.stock <= minimo) {
        opt.disabled = true;
        opt.textContent += ' - BLOQUEADO (stock mínimo)';
      }
      selectProductos.appendChild(opt);
    });
    btnVender.disabled = false;
    selectProductos.selectedIndex = 0;
  }

  function venderProducto() {
    const id = parseInt(selectProductos.value);
    if (!id) return;
    const p = productos.find(x => x.id === id);
    if (!p || p.stock <= minimo) return;
    p.stock--;
    localStorage.setItem('productos', JSON.stringify(productos));
    cargarProductos();
  }

  function descargarReporte() {
    const productosMinimos = productos.filter(p => p.stock <= minimo);
    let texto = 'Productos en stock mínimo:\n\n';
    if (productosMinimos.length === 0) texto += 'No hay productos en stock mínimo.';
    else {
      productosMinimos.forEach(p => {
        texto += `- ${p.nombre}: ${p.stock} unidades\n`;
      });
    }
    const blob = new Blob([texto], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reporte_stock_minimo.txt';
    a.click();
    URL.revokeObjectURL(url);
  }

  window.addEventListener('storage', (e) => {
    if (e.key === 'productos') {
      cargarProductos();
    }
  });

  // Refrescar cada 3 segundos para sincronizar si fuera necesario
  setInterval(() => {
    const data = localStorage.getItem('productos');
    if (data) {
      const actual = JSON.parse(data);
      if (JSON.stringify(actual) !== JSON.stringify(productos)) {
        productos = actual;
        actualizarSelect();
      }
    }
  }, 3000);

  btnVender.onclick = () => {
    venderProducto();
  };

  btnDescargar.onclick = () => {
    descargarReporte();
  };

  cargarProductos();
</script>
</body>
</html>
