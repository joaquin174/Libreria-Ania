<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vender - Modo Celular</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://i.ibb.co/4ZTTVkgx/papeleria-1-66fe77df-9580-4bae-9e3c-4ce0f59fa290.webp') no-repeat center center fixed;
      background-size: cover;
      backdrop-filter: blur(8px);
      margin: 0;
      padding: 20px;
      color: #fff;
    }
    .container {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 20px;
      padding: 20px;
      max-width: 400px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    select, button, input {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 10px;
      font-size: 16px;
    }
    button {
      background: linear-gradient(145deg, #00f0ff, #0088ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: all 0.2s ease-in-out;
    }
    button:hover {
      transform: scale(1.05);
    }
    canvas {
      margin-top: 10px;
      border: 2px solid white;
      border-radius: 10px;
    }
    .flex {
      display: flex;
      flex-direction: row;
      gap: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Vender Producto</h2>
    
    <!-- Selector de producto -->
    <select id="producto"></select>

    <!-- Buscador por ID -->
    <div class="flex">
      <input type="text" id="buscarIdInput" placeholder="ID del producto..." />
      <button onclick="buscarProductoPorId()">🔍</button>
    </div>

    <!-- Botones de acción -->
    <button onclick="venderProducto()">🛒 Vender</button>
    <button id="descargarInformeBtn">📄 Descargar informe stock mínimo</button>

    <!-- Botón QR -->
    <button onclick="generarQR()">📱 Generar QR de esta página</button>
    <canvas id="qrCanvas"></canvas>
  </div>

  <!-- QRious para generar QR -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <script>
    const selector = document.getElementById("producto");

    // Cargar productos desde localStorage
    function cargarProductos() {
      const productos = JSON.parse(localStorage.getItem("productos") || "[]");
      selector.innerHTML = "";

      productos.forEach(producto => {
        const option = document.createElement("option");
        option.value = producto.id;
        option.textContent = `${producto.nombre} (Stock: ${producto.stock})`;

        // Desactivar si stock mínimo
        if (producto.stock <= 1) {
          option.disabled = true;
        }

        selector.appendChild(option);
      });
    }

    // Vender producto seleccionado
    function venderProducto() {
      const idSeleccionado = selector.value;
      let productos = JSON.parse(localStorage.getItem("productos") || "[]");
      const index = productos.findIndex(p => p.id === idSeleccionado);
      if (index !== -1 && productos[index].stock > 0) {
        productos[index].stock--;
        localStorage.setItem("productos", JSON.stringify(productos));
        cargarProductos();
        alert(`Producto "${productos[index].nombre}" vendido. Stock actual: ${productos[index].stock}`);
      } else {
        alert("No se puede vender. Stock mínimo alcanzado.");
      }
    }

    // Buscar producto por ID
    function buscarProductoPorId() {
      const idBuscado = document.getElementById('buscarIdInput').value.trim();
      const opciones = selector.options;
      let encontrado = false;

      for (let i = 0; i < opciones.length; i++) {
        if (opciones[i].value === idBuscado) {
          selector.selectedIndex = i;
          encontrado = true;
          break;
        }
      }

      if (!encontrado) {
        alert("Producto con ese ID no encontrado.");
      }
    }

    // Generar código QR
    function generarQR() {
      new QRious({
        element: document.getElementById('qrCanvas'),
        value: window.location.href,
        size: 200
      });
    }

    // Descargar informe de productos con stock mínimo
    document.getElementById("descargarInformeBtn").onclick = function () {
      const productos = JSON.parse(localStorage.getItem("productos") || "[]");
      const stockMinimo = productos.filter(p => p.stock <= 1);
      if (stockMinimo.length === 0) {
        alert("No hay productos con stock mínimo.");
        return;
      }

      const texto = stockMinimo.map(p =>
        `ID: ${p.id}\nNombre: ${p.nombre}\nStock: ${p.stock}\n\n`
      ).join("");

      const blob = new Blob([texto], { type: "text/plain" });
      const enlace = document.createElement("a");
      enlace.href = URL.createObjectURL(blob);
      enlace.download = "informe_stock_minimo.txt";
      enlace.click();
    };

    // Cargar productos al inicio y generar QR automáticamente
    window.onload = () => {
      cargarProductos();
      generarQR();
    };
  </script>
</body>
</html>
